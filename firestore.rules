rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // SUPER ADMIN OVERRIDE - Admins can access everything
    match /{document=**} {
      allow read, write: if request.auth != null && (
        request.auth.token.role == 'admin' ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true)
      );
    }
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return request.auth.token.role == role;
    }
    
    function isGlobalAdmin() {
      return hasRole('admin');
    }
    
    // Super Admin functions - can override all permissions
    function isSuperAdmin() {
      return isAuthenticated() && (
        hasRole('admin') ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true)
      );
    }
    
    function canAdminAccess() {
      return isSuperAdmin();
    }
    
    function isInstitutionAdmin() {
      return hasRole('institution');
    }
    
    function belongsToSameInstitution(institutionId) {
      return request.auth.token.institutionId == institutionId;
    }
    
    function isLinkedParent(userId) {
      return hasRole('parent') && 
             request.auth.token.studentIds != null &&
             userId in request.auth.token.studentIds;
    }
    
    function isInAllowedCohort(allowedCohortIds) {
      return request.auth.token.cohortIds != null &&
             allowedCohortIds.hasAny(request.auth.token.cohortIds);
    }
    
    function canAccessInstitutionData(institutionId) {
      return isGlobalAdmin() || 
             (institutionId != null && belongsToSameInstitution(institutionId));
    }

    // Users collection - Multi-tenant with role-based access + Super Admin override
    match /users/{userId} {
      // Super admins can do anything
      allow read, write: if canAdminAccess();
      
      // Regular permissions
      allow read: if isAuthenticated() && (
        isOwner(userId) || 
        isGlobalAdmin() || 
        (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId)) ||
        isLinkedParent(userId)
      );
      
      allow create: if isAuthenticated() && (
        isOwner(userId) ||
        isGlobalAdmin() ||
        isInstitutionAdmin()
      );
      
      allow update: if isAuthenticated() && (
        isOwner(userId) || 
        isGlobalAdmin() ||
        (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId))
      );
      
      allow delete: if isGlobalAdmin();
    }

    // Institutions collection
    match /institutions/{institutionId} {
      // Super admins can do anything
      allow read, write: if canAdminAccess();
      
      allow read: if isAuthenticated() && (
        belongsToSameInstitution(institutionId) || 
        isGlobalAdmin()
      );
      
      allow create: if isGlobalAdmin();
      
      allow update: if isAuthenticated() && (
        (isInstitutionAdmin() && belongsToSameInstitution(institutionId)) ||
        isGlobalAdmin()
      );
      
      allow delete: if isGlobalAdmin();
    }

    // Cohorts collection - Institution scoped
    match /cohorts/{cohortId} {
      allow read: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId) ||
        (hasRole('student') && request.auth.uid in resource.data.studentIds) ||
        (hasRole('parent') && resource.data.studentIds.hasAny(request.auth.token.studentIds))
      );
      
      allow create, update: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin() || 
                     (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId));
    }

    // Courses collection - All authenticated users with paid plans can access
    match /courses/{courseId} {
      // Allow any authenticated user to read courses (subscription check happens at app level)
      allow read: if isAuthenticated();
      
      // Only admins and content creators can create/modify courses
      allow create, update, delete: if isAuthenticated() && (
        isGlobalAdmin() ||
        hasRole('content-creator') ||
        canAccessInstitutionData(resource.data.institutionId)
      );
    }

    // Progress tracking - User + Institution scoped
    match /progress/{progressId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId) ||
        isLinkedParent(resource.data.userId)
      );
      
      allow create, update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin() ||
                     (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId));
    }

    // Webinars collection - Authenticated users can read, creators can create
    match /webinars/{webinarId} {
      // All authenticated users can read published webinars
      allow read: if isAuthenticated();
      
      // Content creators and admins can create/modify webinars
      allow create, update, delete: if isAuthenticated() && (
        isGlobalAdmin() ||
        hasRole('content-creator') ||
        canAccessInstitutionData(resource.data.institutionId)
      );
    }

    // Webinar registrations - Users can register themselves
    match /webinarRegistrations/{registrationId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin()
      );
      
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      allow update, delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin()
      );
    }

    // Attendance tracking
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId) ||
        isLinkedParent(resource.data.userId)
      );
      
      allow create, update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin() ||
                     (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId));
    }

    // Careers - Public read access for all users (authenticated or not)
    match /careers/{careerId} {
      allow read: if true; // Public read access to career information
      allow create, update, delete: if isGlobalAdmin(); // Only admins can manage careers
    }

    // Industry news - Public read access
    match /industryNews/{newsId} {
      allow read: if isAuthenticated() && resource.data.isPublished;
      allow create, update, delete: if isGlobalAdmin();
    }

    // Student Grades - Personal data, student-owned
    match /studentGrades/{userId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) || // Student can read their own grades
        isGlobalAdmin() || // Admins can read all grades
        hasRole('content-creator') // Teachers can read grades
      );
      allow create: if isAuthenticated() && isOwner(userId); // Students can create their own grade records
      allow update: if isAuthenticated() && (
        isOwner(userId) || // Students can update their own grades
        hasRole('content-creator') // Teachers can update student grades
      );
      allow delete: if isGlobalAdmin(); // Only admins can delete grade records
    }

    // Events - Institution scoped
    match /events/{eventId} {
      allow read: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId) ||
        (hasRole('student') && resource.data.cohortIds.hasAny(request.auth.token.cohortIds))
      );
      
      allow create, update, delete: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId)
      );
    }

    // Addons - Institution scoped
    match /addons/{addonId} {
      allow read: if isAuthenticated() && (
        resource.data.isActive &&
        (canAccessInstitutionData(resource.data.institutionId) || resource.data.institutionId == null)
      );
      
      allow create, update, delete: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId)
      );
    }

    // Purchases - User + Institution admin access
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create, update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin();
    }

    // Rewards - User + Institution scoped
    match /rewards/{rewardId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId) ||
        isLinkedParent(resource.data.userId)
      );
      
      allow create, update: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin() ||
                     (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId));
    }

    // Leaderboards - Institution scoped with public visibility
    match /leaderboards/{leaderboardId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create, update, delete: if isAuthenticated() && (
        canAccessInstitutionData(resource.data.institutionId)
      );
    }

    // Payments and subscriptions (admin only)
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create, update, delete: if isGlobalAdmin() ||
                                      (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId));
    }

    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create, update, delete: if isGlobalAdmin() ||
                                      (isInstitutionAdmin() && belongsToSameInstitution(resource.data.institutionId));
    }

    // Chat messages (webinar participants only)
    match /webinar_chats/{chatId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && isOwner(resource.data.userId);
      
      allow update, delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
    }

    // Questions (webinar participants only)
    match /webinar_questions/{questionId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && isOwner(resource.data.userId);
      
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow delete: if isOwner(resource.data.userId) || 
                     canAccessInstitutionData(resource.data.institutionId);
    }

    // Careers collection - Read-only for all authenticated users
    match /careers/{careerId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin();
    }

    // Industry News collection - Read-only for all authenticated users
    match /industryNews/{newsId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin(); // Only Cloud Functions (with admin privileges) can write
    }

    // Life Skills Modules collection - Read-only for all authenticated users
    match /lifeSkillsModules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin();
    }

    // Wellbeing Progress collection - User can read/write their own progress
    match /wellbeingProgress/{progressId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      
      allow delete: if isOwner(resource.data.userId) || isGlobalAdmin();
    }

    // Wellbeing Check-ins collection - User can read/write their own check-ins
    match /wellbeingCheckins/{checkinId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      
      allow delete: if isOwner(resource.data.userId) || isGlobalAdmin();
    }

    // Point Transactions collection - Users can read their own, admins can write
    match /pointTransactions/{transactionId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create: if isGlobalAdmin(); // Only system/admin can create
      
      allow update, delete: if isGlobalAdmin();
    }

    // Leaderboards collection - Read-only for authenticated users
    match /leaderboards/{leaderboardId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin(); // Only Cloud Functions can write
    }

    // Rewards collection - Read-only for authenticated users
    match /rewards/{rewardId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin() || isInstitutionAdmin();
    }

    // Redemptions collection - Users can read their own
    match /redemptions/{redemptionId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      allow update: if isGlobalAdmin(); // Only system can update status
      
      allow delete: if isGlobalAdmin();
    }

    // Add-Ons collection - Read-only for authenticated users
    match /addons/{addonId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin() || isInstitutionAdmin();
    }

    // Purchases collection - Users can read their own purchases
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create: if isAuthenticated(); // Stripe webhook creates purchases
      
      allow update: if isGlobalAdmin(); // Only system can update status
      
      allow delete: if isGlobalAdmin();
    }

    // Cohorts collection - Institution admins can manage their cohorts
    match /cohorts/{cohortId} {
      allow read: if isAuthenticated() && (
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId) ||
        isLinkedParent(resource.data.studentIds)
      );
      
      allow create, update: if isAuthenticated() && (
        isGlobalAdmin() ||
        canAccessInstitutionData(request.resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin() || canAccessInstitutionData(resource.data.institutionId);
    }

    // Referral Links collection - Institution admins can manage their links
    match /referralLinks/{linkId} {
      allow read: if isAuthenticated() && (
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow create, update: if isAuthenticated() && (
        isGlobalAdmin() ||
        canAccessInstitutionData(request.resource.data.institutionId)
      );
      
      allow delete: if isGlobalAdmin() || canAccessInstitutionData(resource.data.institutionId);
    }

    // Parent-Student Links collection - Parents and students can read their own links
    match /parentStudentLinks/{linkId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.parentId) ||
        isOwner(resource.data.studentId) ||
        isGlobalAdmin()
      );
      
      allow create: if isAuthenticated();
      
      allow update, delete: if isAuthenticated() && (
        isOwner(resource.data.parentId) ||
        isOwner(resource.data.studentId) ||
        isGlobalAdmin()
      );
    }

    // Institution Analytics collection - Institution admins can read their analytics
    match /institutionAnalytics/{analyticsId} {
      allow read: if isAuthenticated() && (
        isGlobalAdmin() ||
        canAccessInstitutionData(resource.data.institutionId)
      );
      
      allow write: if isGlobalAdmin(); // Only system can write analytics
    }

    // AI Sessions
    match /aiSessions/{sessionId} {
      // Users can read and create their own sessions
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // AI Messages
    match /aiMessages/{messageId} {
      // Users can read their own messages
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // No updates or deletes allowed for message history integrity
    }

    // AI Usage
    match /aiUsage/{usageId} {
      // Users can read their own usage stats
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // Only system/admin can write usage stats
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    // AI FAQs
    match /faqs/{faqId} {
      // Everyone can read FAQs
      allow read: if request.auth != null;
      // Only admins can create/update FAQs
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    // AI Audit Logs
    match /aiAuditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if request.auth != null && request.auth.token.role == 'admin';
      // Only system can write audit logs
      allow create: if request.auth != null;
    }

    // Interview Lab: Questions
    match /interviewQuestions/{questionId} {
      // All authenticated users can read active questions
      allow read: if isAuthenticated();
      
      // Only admins and content creators can create/update/delete questions
      allow create, update, delete: if isAuthenticated() && (
        isGlobalAdmin() ||
        hasRole('content-creator')
      );
    }

    // Interview Lab: Responses
    match /interviewResponses/{responseId} {
      // Users can read their own responses, admins/creators can read all
      allow read: if isAuthenticated() && (
        isOwner(resource.data.studentId) ||
        isGlobalAdmin() ||
        hasRole('content-creator')
      );
      
      // Users can create their own responses
      allow create: if isAuthenticated() && isOwner(request.resource.data.studentId);
      
      // Users can update their own responses, admins/creators can update any (for feedback)
      allow update: if isAuthenticated() && (
        isOwner(resource.data.studentId) ||
        isGlobalAdmin() ||
        hasRole('content-creator')
      );
      
      // Only admins and content creators can delete
      allow delete: if isAuthenticated() && (
        isGlobalAdmin() ||
        hasRole('content-creator')
      );
    }

    // Student Reviews
    match /studentReviews/{reviewId} {
      // Public can read approved and featured reviews (for homepage display)
      // Anyone can read all reviews if authenticated (for admin panel)
      allow read: if resource.data.status == 'approved' && resource.data.featured == true ||
                     isAuthenticated();
      
      // Students can create their own review OR external reviews via public link
      allow create: if (isAuthenticated() && 
                        request.resource.data.studentId == request.auth.uid &&
                        request.resource.data.status == 'pending') ||
                       (request.resource.data.studentId == 'external-review' &&
                        request.resource.data.status == 'pending' &&
                        request.resource.data.source == 'external-link');
      
      // Only admins and content creators can update reviews (approve/reject/feature)
      allow update: if isAuthenticated() && (
        isGlobalAdmin() ||
        hasRole('content-creator')
      );
      
      // Only admins can delete reviews
      allow delete: if isGlobalAdmin();
    }

    // Founders collection - Public read access, admin write
    match /founders/{founderId} {
      // Anyone can read active founder profiles (for homepage display)
      allow read: if true;
      
      // Only admins can create, update, or delete founder profiles
      allow create, update, delete: if isGlobalAdmin();
    }

    // Debate Topics collection - Read-only for authenticated users
    match /debateTopics/{topicId} {
      // All authenticated users can read debate topics
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete debate topics
      allow create, update, delete: if isGlobalAdmin();
    }

    // Debate Submissions collection - Students submit, admins grade
    match /debateSubmissions/{submissionId} {
      // Students can read their own submissions, admins can read all
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isGlobalAdmin()
      );
      
      // Students can create their own submissions
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      // Only admins can update (for grading and feedback)
      allow update: if isGlobalAdmin();
      
      // Only admins can delete
      allow delete: if isGlobalAdmin();
    }

    // Virtual Debates collection - Authenticated users can read, admins can manage
    match /virtualDebates/{debateId} {
      // All authenticated users can read virtual debates
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete virtual debates
      allow create, update, delete: if isGlobalAdmin();
    }

    // Experts collection - Public read access for homepage display
    match /experts/{expertId} {
      // Anyone can read expert profiles (for homepage display)
      allow read: if true;
      
      // Only admins can create, update, or delete expert profiles
      allow create, update, delete: if isGlobalAdmin();
    }

    // Success Stories collection - Public read access for homepage display
    match /successStories/{storyId} {
      // Anyone can read success stories (for homepage display)
      allow read: if true;
      
      // Only admins can create, update, or delete success stories
      allow create, update, delete: if isGlobalAdmin();
    }

    // Default deny all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
